# 3. System Configuration & Services
          AIROOTFS_DIR="/tmp/archlive/airootfs"
          SYSTEMD_DIR="$AIROOTFS_DIR/etc/systemd/system"
          MULTI_USER_DIR="$SYSTEMD_DIR/multi-user.target.wants"

          mkdir -p "$SYSTEMD_DIR"
          mkdir -p "$MULTI_USER_DIR"

          # [3-1] Enable Services (Symlinks)
          ln -sf /usr/lib/systemd/system/sddm.service "$SYSTEMD_DIR/display-manager.service"
          ln -sf /usr/lib/systemd/system/NetworkManager.service "$MULTI_USER_DIR/NetworkManager.service"
          ln -sf /usr/lib/systemd/system/bluetooth.service "$MULTI_USER_DIR/bluetooth.service"

          # ==================================================================
          # [CRITICAL FIX] Manually Create User 'arch'
          # SDDM starts before the live script creates the user, so we inject it now.
          # ==================================================================
          
          # 1. Create User Entry in /etc/passwd (User: arch, UID: 1000, Shell: /bin/zsh)
          # Note: We use zsh because it is the standard shell in archiso releng
          echo "arch:x:1000:1000::/home/arch:/bin/zsh" >> "$AIROOTFS_DIR/etc/passwd"

          # 2. Create Shadow Entry (No password)
          echo "arch:::0:99999:7:::" >> "$AIROOTFS_DIR/etc/shadow"

          # 3. Create Group Entry (arch group)
          echo "arch:x:1000:" >> "$AIROOTFS_DIR/etc/group"

          # 4. Add 'arch' to 'wheel' group (for sudo access)
          # We append user 'arch' to the 'wheel' group line in /etc/group
          sed -i 's/^wheel:x:998:$/wheel:x:998:arch/' "$AIROOTFS_DIR/etc/group"

          # 5. Enable Passwordless Sudo for wheel group
          mkdir -p "$AIROOTFS_DIR/etc/sudoers.d"
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > "$AIROOTFS_DIR/etc/sudoers.d/00-wheel-nopasswd"
          chmod 440 "$AIROOTFS_DIR/etc/sudoers.d/00-wheel-nopasswd"

          # ==================================================================
          # [SDDM & Session Setup]
          # ==================================================================

          # [3-2] Configure SDDM Auto-login
          mkdir -p "$AIROOTFS_DIR/etc/sddm.conf.d"
          cat <<EOF > "$AIROOTFS_DIR/etc/sddm.conf.d/autologin.conf"
          [Autologin]
          User=arch
          Session=plasma.desktop
          Relogin=false
          EOF
          chmod 755 "$AIROOTFS_DIR/etc/sddm.conf.d"

          # [3-3] Fix Home Directory Permissions
          # Essential! Without this, Plasma crashes immediately and loops back to SDDM.
          mkdir -p "$AIROOTFS_DIR/home/arch"
          chown -R 1000:1000 "$AIROOTFS_DIR/home/arch"
          
          # [3-4] Fix PAM for Passwordless Login
          # Force SDDM to accept empty password login
          sed -i 's/^auth.*include.*system-login/auth sufficient pam_permit.so/' "$AIROOTFS_DIR/etc/pam.d/sddm"
