name: Daily Arch ISO Build & Release

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight (UTC)
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  # [Job 1] Build ISO (Arch Linux Environment)
  build_iso:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso make git

      - name: Configure ISO Profile
        run: |
          # 1. Copy default releng profile
          cp -r /usr/share/archiso/configs/releng /tmp/archlive
          
          # 2. Append Custom Packages from external file
          # Read 'custom_packages.x86_64' from the repository and append to the ISO config
          if [ -f "custom_packages.x86_64" ]; then
            cat custom_packages.x86_64 >> /tmp/archlive/packages.x86_64
            echo "Custom packages appended successfully."
          else
            echo "Error: custom_packages.x86_64 file not found!"
            exit 1
          fi

          # 3. System Configuration & Services
          AIROOTFS_DIR="/tmp/archlive/airootfs"
          SYSTEMD_DIR="$AIROOTFS_DIR/etc/systemd/system"
          MULTI_USER_DIR="$SYSTEMD_DIR/multi-user.target.wants"

          mkdir -p "$SYSTEMD_DIR"
          mkdir -p "$MULTI_USER_DIR"

          # [3-1] Enable Services (Symlinks)
          
          # SDDM (Display Manager)
          ln -sf /usr/lib/systemd/system/sddm.service "$SYSTEMD_DIR/display-manager.service"
          
          # NetworkManager
          ln -sf /usr/lib/systemd/system/NetworkManager.service "$MULTI_USER_DIR/NetworkManager.service"
          
          # Bluetooth
          ln -sf /usr/lib/systemd/system/bluetooth.service "$MULTI_USER_DIR/bluetooth.service"

          # [3-2] Configure SDDM Auto-login
          mkdir -p "$AIROOTFS_DIR/etc/sddm.conf.d"
          cat <<EOF > "$AIROOTFS_DIR/etc/sddm.conf.d/autologin.conf"
          [Autologin]
          User=arch
          Session=plasma
          EOF
          
          chmod 755 "$AIROOTFS_DIR/etc/sddm.conf.d"

      - name: Build ISO
        run: |
          mkarchiso -v -w /tmp/archiso-work -o ./out /tmp/archlive

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-iso
          path: out/*.iso
          retention-days: 1

  # [Job 2] Update Release
  update_release:
    needs: build_iso
    runs-on: ubuntu-latest
    
    steps:
      - name: Download ISO Artifact
        uses: actions/download-artifact@v4
        with:
          name: built-iso
          path: ./iso-files

      - name: Delete Old Release & Tag
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          delete_release: true 
          tag_name: rolling
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create New Release & Upload ISO
        uses: softprops/action-gh-release@v2
        with:
          name: Daily Arch Linux Plasma (Wayland)
          tag_name: rolling
          body: |
            ### ðŸš€ Daily Build
            Automatic daily build of Arch Linux with KDE Plasma (Wayland).
            
            **Features:**
            - **Desktop:** KDE Plasma 6 (Wayland)
            - **Browser:** Firefox
            - **Apps:** Kate, Ark, PartitionManager, etc.
            - **System:** PipeWire, Bluetooth, NetworkManager
            - **Login:** Auto-login enabled (User: `arch`)
            
            *Built on: ${{ github.event.repository.updated_at }}*
          files: ./iso-files/*.iso
          prerelease: false
          make_latest: true
