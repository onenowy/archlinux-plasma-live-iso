name: Clean Arch Plasma ISO Build

on:
  workflow_dispatch:      # Manual trigger only

jobs:
  build_iso:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso make git sed

      - name: Configure Clean Profile & Polish
        run: |
          # 1. Copy releng skeleton
          cp -r /usr/share/archiso/configs/releng /tmp/archlive
          
          # ==================================================================
          # [STEP 1] Overwrite Package List
          # ==================================================================
          if [ -f "package_list.x86_64" ]; then
            echo "Overwriting package list..."
            sed 's/#.*//;s/[ \t]*$//;/^$/d' package_list.x86_64 > /tmp/archlive/packages.x86_64
          else
            echo "Error: package_list.x86_64 not found!"
            exit 1
          fi

          # ==================================================================
          # [STEP 2] Customize ISO Metadata & Boot Menu (The "Polish")
          # ==================================================================
          
          # 2-1. Modify profiledef.sh (ISO Name & Label)
          # Change iso_name to "arch-plasma"
          sed -i 's/iso_name="archlinux"/iso_name="arch-plasma"/' /tmp/archlive/profiledef.sh
          # Change label to "ARCH_PLASMA"
          sed -i 's/iso_label="ARCH_%Y%m"/iso_label="ARCH_PLASMA"/' /tmp/archlive/profiledef.sh

          # 2-2. Modify Boot Menu Labels (UEFI & BIOS)
          # Change "Arch Linux install medium" to "Arch Linux Plasma (Wayland)"
          sed -i 's/Arch Linux install medium/Arch Linux Plasma (Wayland)/g' \
            /tmp/archlive/syslinux/archiso_sys-linux.cfg \
            /tmp/archlive/efiboot/loader/entries/01-archiso-x86_64-linux.conf

          # ==================================================================
          # [STEP 3] Reset Services & Cleanup Residue
          # ==================================================================
          AIROOTFS_DIR="/tmp/archlive/airootfs"
          SYSTEMD_DIR="$AIROOTFS_DIR/etc/systemd/system"
          MULTI_USER_DIR="$SYSTEMD_DIR/multi-user.target.wants"

          # 3-1. Wipe default services (Remove networkd, espeakup, brltty hooks)
          echo "Wiping default service symlinks..."
          rm -rf "$MULTI_USER_DIR"/*
          rm -rf "$SYSTEMD_DIR"/getty.target.wants/*
          
          # 3-2. Remove releng install scripts residue
          # These are physical files provided by releng for the installation guide
          rm -f "$AIROOTFS_DIR/root/install.txt"
          
          # ==================================================================
          # [STEP 4] Safe User & Permission Setup
          # ==================================================================
          mkdir -p "$AIROOTFS_DIR/usr/lib/sysusers.d"
          cat <<EOF > "$AIROOTFS_DIR/usr/lib/sysusers.d/arch-groups.conf"
          u arch 1000 "Arch Linux Live User" /home/arch /bin/bash
          m arch input
          m arch video
          m arch render
          m arch audio
          m arch optical
          m arch storage
          m arch wheel
          m arch rfkill
          EOF

          # Enable Passwordless Sudo
          mkdir -p "$AIROOTFS_DIR/etc/sudoers.d"
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > "$AIROOTFS_DIR/etc/sudoers.d/00-wheel-nopasswd"
          chmod 440 "$AIROOTFS_DIR/etc/sudoers.d/00-wheel-nopasswd"

          # ==================================================================
          # [STEP 5] Enable Essential Services
          # ==================================================================
          ln -sf /usr/lib/systemd/system/sddm.service "$SYSTEMD_DIR/display-manager.service"
          ln -sf /usr/lib/systemd/system/NetworkManager.service "$MULTI_USER_DIR/NetworkManager.service"
          ln -sf /usr/lib/systemd/system/bluetooth.service "$MULTI_USER_DIR/bluetooth.service"

          # ==================================================================
          # [STEP 6] Desktop Configuration
          # ==================================================================
          mkdir -p "$AIROOTFS_DIR/etc/sddm.conf.d"
          cat <<EOF > "$AIROOTFS_DIR/etc/sddm.conf.d/autologin.conf"
          [Autologin]
          User=arch
          Session=plasma.desktop
          Relogin=false
          [General]
          DisplayServer=wayland
          EOF
          chmod 755 "$AIROOTFS_DIR/etc/sddm.conf.d"

          mkdir -p "$AIROOTFS_DIR/home/arch"
          chown -R 1000:1000 "$AIROOTFS_DIR/home/arch"
          
          mkdir -p "$AIROOTFS_DIR/etc/pam.d"
          cat <<EOF > "$AIROOTFS_DIR/etc/pam.d/sddm"
          #%PAM-1.0
          auth     sufficient  pam_permit.so
          account  include     system-login
          password include     system-login
          session  include     system-login
          EOF

      - name: Build ISO
        run: |
          mkarchiso -v -w /tmp/archiso-work -o ./out /tmp/archlive

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Clean-Arch-Plasma-ISO
          path: out/*.iso
          retention-days: 3