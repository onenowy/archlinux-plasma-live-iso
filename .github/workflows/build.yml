name: Manual Arch ISO Build (Standard)

on:
  workflow_dispatch:      # Manual trigger only

jobs:
  build_iso:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged # Privileged mode required for mounting filesystems
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Build Tools & Fix Mirrors
        run: |
          # 1. Update Keyring & Database first to avoid signature errors
          pacman -Sy --noconfirm archlinux-keyring
          
          # 2. Install Archiso and Reflector (Mirror tool)
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso make git reflector

          # 3. [FIX] Update Mirrorlist to fix 'target not found' errors
          # GitHub Runners are in the US/Azure, so we need fresh mirrors.
          echo "Updating mirrorlist..."
          reflector --latest 20 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
          
          # 4. Force refresh package database with new mirrors
          pacman -Syy --noconfirm

      - name: Configure ISO Profile
        run: |
          # 1. Copy default releng profile
          cp -r /usr/share/archiso/configs/releng /tmp/archlive
          
          # 2. Append Custom Packages (Only new ones)
          if [ -f "custom_packages.x86_64" ]; then
            cat custom_packages.x86_64 >> /tmp/archlive/packages.x86_64
            echo "Custom packages appended successfully."
          else
            echo "Error: custom_packages.x86_64 file not found!"
            exit 1
          fi

          # 3. System Configuration & Services
          AIROOTFS_DIR="/tmp/archlive/airootfs"
          SYSTEMD_DIR="$AIROOTFS_DIR/etc/systemd/system"
          MULTI_USER_DIR="$SYSTEMD_DIR/multi-user.target.wants"

          mkdir -p "$SYSTEMD_DIR"
          mkdir -p "$MULTI_USER_DIR"

          # [3-1] Enable Services
          ln -sf /usr/lib/systemd/system/sddm.service "$SYSTEMD_DIR/display-manager.service"
          ln -sf /usr/lib/systemd/system/NetworkManager.service "$MULTI_USER_DIR/NetworkManager.service"
          ln -sf /usr/lib/systemd/system/bluetooth.service "$MULTI_USER_DIR/bluetooth.service"

          # ==================================================================
          # [CRITICAL FIX] Hardware Permissions & User Setup
          # ==================================================================
          
          # Ensure config files exist
          [ ! -f "$AIROOTFS_DIR/etc/passwd" ] && touch "$AIROOTFS_DIR/etc/passwd"
          [ ! -f "$AIROOTFS_DIR/etc/shadow" ] && touch "$AIROOTFS_DIR/etc/shadow"
          [ ! -f "$AIROOTFS_DIR/etc/group" ] && touch "$AIROOTFS_DIR/etc/group"

          # 1. Manually Create User 'arch' (Before SDDM starts)
          echo "arch:x:1000:1000::/home/arch:/bin/zsh" >> "$AIROOTFS_DIR/etc/passwd"
          echo "arch:::0:99999:7:::" >> "$AIROOTFS_DIR/etc/shadow"
          echo "arch:x:1000:" >> "$AIROOTFS_DIR/etc/group"
          
          # 2. Add 'arch' to Hardware Groups (Fixes Mouse/Keyboard freeze)
          add_user_to_group() {
            GROUP="$1"
            USER="arch"
            FILE="$AIROOTFS_DIR/etc/group"
            if grep -q "^$GROUP:" "$FILE"; then
              # Append user to existing group line
              sed -i "s/^$GROUP:x:[0-9]*:$/&${USER}/;s/^$GROUP:x:[0-9]*:.*/&,${USER}/" "$FILE"
              sed -i 's/,,/,/g' "$FILE"
            else
              echo "Warning: Group $GROUP not found in /etc/group"
            fi
          }

          # CRITICAL GROUPS for Real Hardware & Wayland:
          for group in wheel input video render audio optical storage lp; do
             add_user_to_group "$group"
          done

          # 3. Enable Passwordless Sudo
          mkdir -p "$AIROOTFS_DIR/etc/sudoers.d"
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > "$AIROOTFS_DIR/etc/sudoers.d/00-wheel-nopasswd"
          chmod 440 "$AIROOTFS_DIR/etc/sudoers.d/00-wheel-nopasswd"

          # ==================================================================
          # [SDDM & Wayland Setup]
          # ==================================================================

          # [3-2] Configure SDDM Auto-login & Force Wayland
          mkdir -p "$AIROOTFS_DIR/etc/sddm.conf.d"
          cat <<EOF > "$AIROOTFS_DIR/etc/sddm.conf.d/autologin.conf"
          [Autologin]
          User=arch
          Session=plasma.desktop
          Relogin=false
          
          [General]
          DisplayServer=wayland
          EOF
          chmod 755 "$AIROOTFS_DIR/etc/sddm.conf.d"

          # [3-3] Fix Home Directory Permissions
          mkdir -p "$AIROOTFS_DIR/home/arch"
          chown -R 1000:1000 "$AIROOTFS_DIR/home/arch"
          
          # [3-4] Fix PAM (Allow passwordless login)
          mkdir -p "$AIROOTFS_DIR/etc/pam.d"
          cat <<EOF > "$AIROOTFS_DIR/etc/pam.d/sddm"
          #%PAM-1.0
          auth     sufficient  pam_permit.so
          account  include     system-login
          password include     system-login
          session  include     system-login
          EOF

      - name: Build ISO
        run: |
          mkarchiso -v -w /tmp/archiso-work -o ./out /tmp/archlive

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Arch-Plasma-Wayland-ISO
          path: out/*.iso
          retention-days: 3